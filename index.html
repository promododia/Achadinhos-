<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Achadinho no Precinho | Oficial</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primaria: #0066ff; --fundo: #f8f9fa; --texto: #1a1a1a; }
        body { font-family: 'Inter', sans-serif; background: var(--fundo); margin: 0; color: var(--texto); }
        header { background: #fff; padding: 12px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .logo { font-weight: 800; color: var(--primaria); font-size: 1.1rem; text-transform: uppercase; }
        .user-area { display: flex; align-items: center; gap: 10px; }
        .user-photo { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--primaria); cursor: pointer; }
        .btn-add { background: var(--primaria); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 22px; font-weight: bold; cursor: pointer; display: none; align-items: center; justify-content: center; }
        .btn-login-discreto { background: #f0f0f0; border: none; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 11px; font-weight: 600; }
        .container { max-width: 450px; margin: 15px auto; padding: 0 15px; }
        #modal-post { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 85%; max-width: 350px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .card { background: #fff; border-radius: 16px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.04); border: 1px solid #efefef; position: relative; }
        .card.esgotado { opacity: 0.5; filter: grayscale(1); }
        .tag-cat { background: #eef2ff; color: var(--primaria); font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 4px; display: inline-block; margin-bottom: 8px; text-transform: uppercase; }
        .card-img { width: 100%; height: 220px; object-fit: contain; background: #fff; padding: 10px; box-sizing: border-box; }
        .card-info { padding: 15px; }
        .card-title { font-size: 0.95rem; font-weight: 600; margin: 0; line-height: 1.3; color: #333; }
        .card-price { font-size: 1.5rem; font-weight: 800; color: #000; margin: 10px 0; display: block; }
        .btn-link { display: block; text-align: center; background: var(--primaria); color: #fff; text-decoration: none; padding: 12px; border-radius: 10px; font-weight: 700; font-size: 14px; border:none; width:100%; cursor:pointer; }
        .btn-link.lock { background: #333; }
        .admin-btns { display: none; padding: 0 15px 15px; gap: 8px; }
        .btn-del { background: #ffeded; color: #ff4d4d; border: 1px solid #ff4d4d; padding: 6px; border-radius: 6px; font-size: 11px; cursor: pointer; flex: 1; font-weight: 600; }
    </style>
</head>
<body>

<header>
    <div class="logo">ACHADINHO</div>
    <div class="user-area">
        <button id="btnLogin" class="btn-login-discreto">Entrar</button>
        <button id="btnAdd" class="btn-add">+</button>
        <img id="userPhoto" class="user-photo" style="display:none" onclick="confirmarSair()">
    </div>
</header>

<div class="container" id="vitrine">
    <p style="text-align:center; margin-top:50px; opacity:0.5">Carregando ofertas...</p>
</div>

<div id="modal-post">
    <div class="modal-content">
        <h3 style="margin:0 0 15px 0; color:var(--primaria)">Novo Achadinho</h3>
        <input type="text" id="p-nome" placeholder="Nome do Produto">
        <input type="text" id="p-preco" placeholder="Preço (Ex: R$ 29,90)">
        <input type="url" id="p-link" placeholder="Link do Produto">
        <input type="url" id="p-img" placeholder="Link da Imagem">
        <select id="p-cat">
            <option value="Variados">Escolha a Categoria</option>
            <option value="Casa">Casa</option>
            <option value="Cozinha">Cozinha</option>
            <option value="Tecnologia">Tecnologia</option>
            <option value="Beleza">Beleza</option>
        </select>
        <button class="btn-link" id="btnPublicar">Publicar no Site</button>
        <button onclick="fecharModal()" style="background:none; border:none; width:100%; margin-top:10px; color:#999; font-size:12px; cursor:pointer">Cancelar</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, push, onValue, query, limitToLast, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCedznZfgv43RRWJmyvA105xFrRhpNTDEw", 
        authDomain: "achadinho-no-precinho.firebaseapp.com", 
        databaseURL: "https://achadinho-no-precinho-default-rtdb.firebaseio.com", 
        projectId: "achadinho-no-precinho", 
        storageBucket: "achadinho-no-precinho.firebasestorage.app", 
        messagingSenderId: "626481618160", 
        appId: "1:626481618160:web:6971d5560c36a47ccd3635" 
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();
    const DONO = "wallyazevedo18@gmail.com";

    let logado = null;

    document.getElementById('btnLogin').onclick = () => signInWithPopup(auth, provider);
    window.confirmarSair = () => { if(confirm("Deseja sair da conta?")) signOut(auth); };
    window.fecharModal = () => document.getElementById('modal-post').style.display = 'none';
    document.getElementById('btnAdd').onclick = () => document.getElementById('modal-post').style.display = 'flex';

    onAuthStateChanged(auth, (user) => {
        logado = user;
        const btnLogin = document.getElementById('btnLogin');
        const btnAdd = document.getElementById('btnAdd');
        const userPhoto = document.getElementById('userPhoto');

        if (user) {
            btnLogin.style.display = 'none';
            userPhoto.style.display = 'block';
            userPhoto.src = user.photoURL;
            if(user.email === DONO) btnAdd.style.display = 'flex';
        } else {
            btnLogin.style.display = 'block';
            userPhoto.style.display = 'none';
            btnAdd.style.display = 'none';
        }
        carregarDados();
    });

    document.getElementById('btnPublicar').onclick = async () => {
        const nome = document.getElementById('p-nome').value;
        const preco = document.getElementById('p-preco').value;
        const link = document.getElementById('p-link').value;
        const img = document.getElementById('p-img').value;
        const cat = document.getElementById('p-cat').value;

        if(!nome || !preco || !link) return alert("Preencha Nome, Preço e Link!");

        await push(ref(db, 'achadinhos'), { nome, preco, link, img, cat, status: 'ativo', data: Date.now() });
        fecharModal();
        document.querySelectorAll('input').forEach(i => i.value = "");
    };

    window.mudarStatus = async (id, status) => {
        const novo = status === 'ativo' ? 'esgotado' : 'ativo';
        await update(ref(db, `achadinhos/${id}`), { status: novo });
    };
    window.excluirItem = async (id) => {
        if(confirm("Apagar esta oferta?")) await remove(ref(db, `achadinhos/${id}`));
    };

    function carregarDados() {
        onValue(query(ref(db, 'achadinhos'), limitToLast(40)), (snapshot) => {
            const vitrine = document.getElementById('vitrine');
            vitrine.innerHTML = "";
            let itens = [];
            snapshot.forEach(doc => { itens.unshift({id: doc.key, ...doc.val()}) });

            if(itens.length === 0) { vitrine.innerHTML = "<p style='text-align:center; margin-top:50px; opacity:0.5'>Nenhuma oferta postada.</p>"; return; }

            itens.forEach(item => {
                const esgotado = item.status === 'esgotado';
                const souDona = logado?.email === DONO;
                
                vitrine.innerHTML += `
                    <div class="card ${esgotado ? 'esgotado' : ''}">
                        ${item.img ? `<img src="${item.img}" class="card-img">` : ''}
                        <div class="card-info">
                            <span class="tag-cat">${item.cat || 'Geral'}</span>
                            <h2 class="card-title">${item.nome}</h2>
                            <span class="card-price">${item.preco}</span>
                            ${!logado 
                                ? `<button class="btn-link lock" onclick="document.getElementById('btnLogin').click()">Login para ver Link</button>`
                                : esgotado 
                                    ? `<span class="btn-link" style="background:#bbb">Esgotado</span>`
                                    : `<a href="${item.link}" target="_blank" class="btn-link">Ir para a Loja</a>`
                            }
                        </div>
                        ${souDona ? `
                            <div class="admin-btns" style="display:flex">
                                <button class="btn-del" style="border-color:#333; color:#333" onclick="mudarStatus('${item.id}', '${item.status}')">
                                    ${esgotado ? 'Reativar' : 'Esgotado'}
                                </button>
                                <button class="btn-del" onclick="excluirItem('${item.id}')">Excluir</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
        });
    }
</script>
</body>
</html>
